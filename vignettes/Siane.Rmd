---
title: "Siane"
author: "Nuno Carvalho dos Santos"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

In this document I will describe and make use of the main functions of this package. The first step is to load the package. Uncomment the first two lines of code in case you haven't installed the package yet.


```{r, warning = FALSE, message = FALSE}
#library(devtools)
#install_github("Nuniemsis/Siane")
library(Siane)
library(pxR)
library(RColorBrewer)

```

## Setting the path of the maps

Siane consists of a collection of maps. This package needs to locate the path of this folder in order to search the requested map.

```{r}
obj <- register_siane("/home/ncarvalho/Descargas/")
```

## Loading a map

Once we have located all the maps we can select one according with our data.
These parameters are enough to specify a map.  
  - `year` : Maps change over time. By now, The territories affected by the changes are just the municipalities(Municipios).  
  - `canarias` : It indicates whether we want to plot Canarias or not.  
  - `level` : It is the administrative level. For this set of maps there are three: "Municipios", "Provincias" and "Comunidades".  
  - `scale` : The scale of the maps. The default scale for municipalities is 1:3000000 `scale <- "3m" `. For provinces and regions the default scale is 1:6500000 `scale <- "6m"`.

```{r}
obj <- "/home/ncarvalho/Descargas"
level <- "Municipios"
canarias <- FALSE
year <- 2016
scale <- "3m"
```

Now we call the `siane_map` function to extract a map from all the map's collection.

```{r}
shp <- siane_map(level = level, obj = obj, year = year, scale = scale) # Reading the map from the maps collection
```

## Plot the map

Did it worked?

```{r,fig.show='hold', fig.width = 5, fig.height = 5}
raster::plot(shp)
```

The spanish political map looks just like this.  Let's try to plot some data on it. To keep following this tutorial you should download previously the data from the INE website. The README.md file explains how to download it. I will also share the [link](http://www.ine.es/jaxiT3/Tabla.htm?t=2879) here in case you already now how to do it.

## Polygon colour plot


#### Data frame reading 

Set the path of the INE data file. It should be in the pc-axis format.
```{r}
ine_path <- "/home/ncarvalho/Descargas/2879.px"
```

Let's explore the dataset before plotting the data
```{r}
df <- as.data.frame(read.px(ine_path))
names(df) # List the column names  of the data frame
```

#### Data frame filtering 

First we need to understand the data frame. It's columns are the following:  
- `Periodo` is the time column in year's format.  
- `value` is a column with the numeric value of the population.  
- `Sexo` is the sex of that population.  
- `Municipios` is a character array with the municipality name and the municipality code
In this dataset there is only one value per territory.

Split the `Municipios` column to get the municipality's codes.  
We are storing the codes in the column `codes`. This column is really important in order to plot the polygons with the correct colours. 


#### Data frame preparation 

```{r}
by <- "codes"
```

We create a single column in the data frame with those codes.
```{r}
df[[by]] <- sapply(df$Municipios,
                   function(x) strsplit(x = as.character(x), split = " ")[[1]][1])
```

```{r}
df$Periodo <- as.numeric(as.character(df$Periodo))
```

Plotting polygons by colour intensity requires one unique value per territory.
Therefore, we have to filter the data frame.  
Keep this __Golden rule__: One value per territory.  
In this example I want to plot the total population in the year 2016.   
```{r}
df <- df[df$Sex == "Total" & df$Periodo == year, ]
```

These are the basic options that you have to set to make the plot.  
- `n` is the number of breaks(optional).  
- `style` is a string that indicates the distribution of the bins(optional).
- `value` is the column name that contains the statistical information you want to plot(required).
- `by` is the column name for the territory codes(required).
- `title` is the plot title(optional).
- `pallete_colour` is a RColorBrewer(famous colours package) pallete.  
Run this line of code to view more colour options. There three sets of colours  
```{r, fig.width = 8, fig.height = 7}
display.brewer.all()
```
Plot the map with the statistical data with the `siane_plot` function.

```{r}
by <- "codes"
title_plot <- "PoblaciÃ³n total por municipios en Zaragoza"
value <- "value"

shp_merged <- siane_merge(shp = shp, df = df,by = by, level = level, value = value)

```


```{r, fig.show='hold', fig.width=7, fig.height = 6}
siane_plot(shp = shp_merged, x = "bottomright")
```

#### Other examples

```{r}
ine_path <- "/home/ncarvalho/Descargas/2852.px"
df <- as.data.frame(read.px(ine_path))
names(df) # List the column names  of the data frame
```

Let's try with a different dataset. This dataset has the spanish population for all the provinces.You can find the link in the README.MD file as well. [Link here](http://www.ine.es/jaxiT3/Tabla.htm?t=2852&L=0)
```{r}
df[[by]] <- sapply(df$Provincias,
                   function(x) strsplit(x = as.character(x), split = " ")[[1]][1])
```

```{r}
df$Periodo <- as.numeric(as.character(df$Periodo))
```

```{r}
df <- df[df$Sex == "Total" & df$Periodo == year,]
```

Remember that first we have to create the shapefile. We can't use the previous shapefile provided that the level has changed.

```{r}
level <- "Provincias"
canarias <- FALSE
year <- 2016
scale <- "6m"
```

Generate the map again.  

```{r, message = FALSE}
shp <- siane_map(obj = obj, canarias = canarias, year = year, level = level, scale = scale)
```
###### Map options


```{r}
value <- "value"
by <- "codes"
```


```{r}
shp_merged <- siane_merge(shp = shp, df = df, by = by, level = level, value = value)
```


#### Plot the map.

```{r, fig.width = 7, fig.height = 7}
pallete_colour <- "BuPu"
n <- 8
style <- "kmeans"


siane_plot(shp = shp_merged, 
           pallete_colour = pallete_colour, n = n, style = style,
            main = "Population", sub = "Fuente:INE", y = 0.20, x = 'bottomright',
            bty = "n", x.intersp = .2, y.intersp = .8)


```


## Combining Siane with another libraries

Please download this data [link](http://www.ine.es/jaxi/Tabla.htm?path=/t20/e245/p05/a2002/l0/&file=00008001.px&L=0). This dataset contains the number of inhabitants of Barcelona's municipalities per five year age groups.
We are now trying to combine leaflet library with Siane to make a higher quality visualization. 

```{r}
library(leaflet)
library(data.table)
```

Reading the map
```{r}
shp <- siane_map(obj = obj, canarias = FALSE, year = 2016,level = "Municipios" ,scale = "3m")
```

Reading the data
```{r}
ine_path <- "/home/ncarvalho/Descargas/00008001.px"
df <- as.data.frame(read.px(ine_path))
df <- as.data.table(df)
```

Calculating the sum of the inhabitants of all ages per sex.
```{r}
df_sum <- df[, sum(value),by = c("Municipios", "Sexo") ]
```

Calculating the percentage of each group of age per municipality and gender
```{r}
df_withsums <- merge(df, df_sum, by = c("Municipios","Sexo"))
df_withsums$perc <- df_withsums$value/df_withsums$V1
```

Filtering the data: Women with 0-4 years old.

```{r}

df_withsums <- df_withsums[df_withsums$Sexo=="Mujeres"&
                           df_withsums$Edad..grupos.quinquenales.=="0-4"]
```


Extracting the territory code for all the municipalities
```{r}
by <- "codes"
value <- "perc"

df_withsums[[by]] <- sapply(df_withsums$Municipios,
                   function(x) strsplit(x = as.character(x), split = " ")[[1]][1])

```


Mergind spatial data and statistical data.

```{r}
shp_merged <- siane_merge(shp = shp, df = df_withsums, by = by,value = value, level = "Municipios")
```

This leaflet code is available [here](https://rstudio.github.io/leaflet/shapes.html)

```{r}

leaflet(shp_merged) %>% 
  addTiles() %>%
  addPolygons(color = "#444444", weight = 1, smoothFactor = 0.5,
    opacity = 1.0, fillOpacity = 0.5,
    fillColor = ~colorQuantile("YlOrRd", perc)(perc),
    highlightOptions = highlightOptions(color = "white", weight = 2,
      bringToFront = TRUE))




```





